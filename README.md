# cheapqueryparser

A simple parser for Lucene/Solr querystrings.

## Target audience

This adresses [CKAN](https://github.com/ckan/ckan) extensions that
implement `IPackageController.before_search`. `before_search` takes a
query as input which then can be modified and returned. Since the
queries generated by CKAN are rather simple, this is often dealt with
in an ad-hoc fashion. However, since any extension can implement
`before_search` and introduce more complicated constructs, one can not
rely on a particular form of this query. Proper parsing of the
querystring, which is aimed at human legibility, turns out to be
astinishingly involved. `cheapqueryparser.lucparser` helps with this.

## Description

This module parses a Lucene query string into a list of tokens,
where each "term" is represented by a dictionary of the form

`{'field': fieldname, 'term': termvalue}`

If a search term is general (doesn't relate to a specific field),
`fieldname=None`.

The module provides two functions:

1. `deparse(querystring)`   
    Takes the querystring an returns a list of tokens, where "terms" are
    replaced with dictionaries {'field': fieldname, 'term': termvalue}.

2. `assemble(termlist)`   
    Takes a list of the form returned by deparse. Returns a querystring.

The implementation of this module is informed by the
[lucene query-parser documentation](https://lucene.apache.org/core/6_6_0/queryparser/org/apache/lucene/queryparser/classic/package-summary.html#package.description).

## Example:

```python

import cheapqueryparser.lucparser as lp

qlist = lp.deparse('author: Meier tags:(water OR fire) "open access"')
print(qlist)

> [{'field': 'author', 'term': 'Meier'},
>  {'field': 'tags', 'term': '( water OR fire )'},
>  {'field': None, 'term': '"open access"'}]


qlist[0]['term'] = '{}{} OR Mueller -Donald{}'.format('(', qlist[0]['term'], ')')
print(qlist)

> [{'field': 'author', 'term': '(Meier OR Mueller -Donald)'},
>  {'field': 'tags', 'term': '( water OR fire )'},
>  {'field': None, 'term': '"open access"'}]

lp.assemble(qlist)

> 'author : (Meier OR Mueller -Donald) tags : ( water OR fire ) "open access"'

```
